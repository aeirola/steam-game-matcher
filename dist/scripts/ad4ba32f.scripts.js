"use strict";angular.module("steamGameMatcherApp",[]),angular.module("steamGameMatcherApp").controller("MainCtrl",["$scope","Steam",function(a,b){a.userInputString="spaceball\nksii",a.users={},a.invalidUsers={},a.games={},a.categories={1:{name:"Multi-player",icon:"ico_multiPlayer.png",selected:!0},9:{name:"Co-op",icon:"ico_coop.png",selected:!1}},a.platforms={windows:{name:"Windows",icon:"platform_win.png",selected:!1},mac:{name:"OS X",icon:"platform_mac.png",selected:!1},linux:{name:"Linux",icon:"platform_linux.png",selected:!1}},a.appsIconUrl="http://media.steampowered.com/steamcommunity/public/images/apps/",a.platformsIconUrl="http://store.steampowered.com/public/images/v5/platforms/",a.categoriesIconUrl="http://store.steampowered.com/public/images/ico/";var c=function(b){a.users[b.steamId]=b,e()},d=function(b){a.invalidUsers[b.steamId]=b};a.search=function(e){a.users={};var g=e.split("\n");b.setAppScore=f;for(var h in g){var i=g[h];b.getSteamUser(i).then(c,d,c)}};var e=function(){var b={};_.forEach(a.users,function(c){_.forEach(c.games,function(d){var e=d.steam_appid||d.appid;b[e]?d=b[e]:(d.owners={},b[e]=d),d.owners[c.steamId]=c.name,d.missingCopies=Object.keys(a.users).length-Object.keys(d.owners).length,f(d)})}),a.games=_.toArray(b)};a.appFilter=function(b){if(!b.loaded)return!0;if("game"!==b.type)return!1;var c;for(c in a.categories)if(a.categories[c].selected&&!b.categories[c])return!1;for(c in a.platforms)if(a.platforms[c].selected&&!b.platforms[c])return!1;return!0};var f=function(a){var b,c,d;if(b=a.metacritic?a.metacritic.score:50,c=a.price_overview?a.price_overview["final"]:.1,a.missingCopies<=0)d=100*b;else{var e=a.missingCopies*c;d=b/e}a.score=d}}]),angular.module("steamGameMatcherApp").service("Steam",["$http","$q",function(a,b){var c="5CDDD4FC0E7A510C4480B310391B8D67",d="http://crossorigin.me/http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/",e="http://crossorigin.me/http://steamcommunity.com/",f="http://crossorigin.me/http://store.steampowered.com/api/appdetails",g=["basic","price_overview","platforms","categories","metacritic"],h=new DOMParser,i={},j=this,k=function(a){var b={};return _.forEach(a.categories,function(a){b[a.id]=a}),a.categories=b,a},l=function(c){var d=b.defer(),e=_.filter(c,function(a){return!(a in i)});_.forEach(e,function(a){i[a]=b.defer()});var h=function(){var a={};_.forEach(c,function(b){a[b]={},i[b].promise.then(function(c){angular.extend(a[b],c)})}),d.resolve(a)};return e?a.get(f+"?filters="+g.join(",")+"&appids="+e.join(",")).success(function(a){_.forIn(a,function(a,c){var d=a.data;d&&(d=k(d)),i[c]||(i[c]=b.defer()),i[c].resolve(d)}),h()}):h(),d.promise},m=function(e){var f=b.defer();return a.get(d+"?key="+c+"&steamid="+e.steamId+"&include_appinfo=1&format=json").success(function(a){var b=a.response.games,c={};_.forEach(b,function(a){c[a.appid]=a}),n(c),e.gameCount=a.response.game_count,e.games=c,f.resolve(e)}),f.promise},n=function(a){var b=function(b){for(var c in b)angular.extend(a[c],b[c],{loaded:!0}),j.setAppScore(a[c])},c=[],d=function(){c.length<=0||(l(c).then(b),c=[])};_.forIn(a,function(a,b){c.push(b),c.length>=1&&d()}),d()},o=function(c){var d,f=b.defer();return d=c.match(/^[0-9]{17}$/)?"profiles/":"id/",a.get(e+d+c+"?xml=1").success(function(a){try{var b=h.parseFromString(a,"text/xml");"private"===b.getElementsByTagName("privacyState")[0].textContent&&f.reject({steamId:b.getElementsByTagName("steamID64")[0].textContent,name:b.getElementsByTagName("steamID")[0].textContent,reason:"Private"}),f.resolve({steamId:b.getElementsByTagName("steamID64")[0].textContent,name:b.getElementsByTagName("steamID")[0].textContent})}catch(d){f.reject({steamId:c,name:c,reason:"Invalid user"})}}).error(function(){f.reject({steamId:c,name:c,reason:"Not found"})}),f.promise};this.setAppScore=function(a){a.score=0},this.getSteamUser=function(a){var c=b.defer();return o(a).then(function(a){m(a).then(c.resolve,c.reject,c.notify),c.notify(a)},c.reject),c.promise}}]);