"use strict";angular.module("steamGameMatcherApp",[]),angular.module("steamGameMatcherApp").controller("MainCtrl",["$scope","Steam",function(a,s){a.userInputString="spaceball\nksii",a.users={},a.invalidUsers={},a.games={},a.categories={1:{name:"Multi-player",icon:"ico_multiPlayer.png",selected:!0},9:{name:"Co-op",icon:"ico_coop.png",selected:!1}},a.platforms={windows:{name:"Windows",icon:"platform_win.png",selected:!1},mac:{name:"OS X",icon:"platform_mac.png",selected:!1},linux:{name:"Linux",icon:"platform_linux.png",selected:!1}},a.appsIconUrl="http://media.steampowered.com/steamcommunity/public/images/apps/",a.platformsIconUrl="http://store.steampowered.com/public/images/v5/platforms/",a.categoriesIconUrl="http://store.steampowered.com/public/images/ico/";var o=function(e){a.users[e.steamId]=e,t()},i=function(e){a.invalidUsers[e.steamId]=e};a.search=function(e){a.users={};var t=e.split("\n");for(var r in s.setAppScore=c,t){var n=t[r];s.getSteamUser(n).then(o,i,o)}};var t=function(){var n={};_.forEach(a.users,function(r){_.forEach(r.games,function(e){var t=e.steam_appid||e.appid;n[t]?e=n[t]:(e.owners={},n[t]=e),e.owners[r.steamId]=r.name,e.missingCopies=Object.keys(a.users).length-Object.keys(e.owners).length,c(e)})}),a.games=_.toArray(n)};a.appFilter=function(e){if(!e.loaded)return!0;if("game"!==e.type)return!1;var t;for(t in a.categories)if(a.categories[t].selected&&!e.categories[t])return!1;for(t in a.platforms)if(a.platforms[t].selected&&!e.platforms[t])return!1;return!0};var c=function(e){var t,r,n;(t=e.metacritic?e.metacritic.score:50,r=e.price_overview?e.price_overview.final:.1,e.missingCopies<=0)?n=100*t:n=t/(e.missingCopies*r);e.score=n}}]),angular.module("steamGameMatcherApp").service("Steam",["$http","$q",function(o,i){var a=["basic","price_overview","platforms","categories","metacritic"],c=new DOMParser,s={},m=this,t=function(e){var t=i.defer(),r=_.filter(e,function(e){return!(e in s)});_.forEach(r,function(e){s[e]=i.defer()});var n=function(){var r={};_.forEach(e,function(t){r[t]={},s[t].promise.then(function(e){angular.extend(r[t],e)})}),t.resolve(r)};return r?o.get("https://cors.io/?https://store.steampowered.com/api/appdetails?filters="+a.join(",")+"&appids="+r.join(",")).success(function(e){_.forIn(e,function(e,t){var r,n,a=e.data;a&&(r=a,n={},_.forEach(r.categories,function(e){n[e.id]=e}),r.categories=n,a=r),s[t]||(s[t]=i.defer()),s[t].resolve(a)}),n()}):n(),t.promise},p=function(r){var e=function(e){for(var t in e)angular.extend(r[t],e[t],{loaded:!0}),m.setAppScore(r[t])},n=[],a=function(){n.length<=0||(t(n).then(e),n=[])};_.forIn(r,function(e,t){n.push(t),1<=n.length&&a()}),a()};this.setAppScore=function(e){e.score=0},this.getSteamUser=function(e){var r,t,n,s=i.defer();return(r=e,n=i.defer(),t=r.match(/^[0-9]{17}$/)?"profiles/":"id/",o.get("https://cors.io/?https://steamcommunity.com/"+t+r+"?xml=1").success(function(e){try{var t=c.parseFromString(e,"text/xml");"private"===t.getElementsByTagName("privacyState")[0].textContent&&n.reject({steamId:t.getElementsByTagName("steamID64")[0].textContent,name:t.getElementsByTagName("steamID")[0].textContent,reason:"Private"}),n.resolve({steamId:t.getElementsByTagName("steamID64")[0].textContent,name:t.getElementsByTagName("steamID")[0].textContent})}catch(e){n.reject({steamId:r,name:r,reason:"Invalid user"})}}).error(function(){n.reject({steamId:r,name:r,reason:"Not found"})}),n.promise).then(function(e){var n,a;(n=e,a=i.defer(),o.get("https://cors.io/?https://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=5CDDD4FC0E7A510C4480B310391B8D67&steamid="+n.steamId+"&include_appinfo=1&format=json").success(function(e){var t=e.response.games,r={};_.forEach(t,function(e){r[e.appid]=e}),p(r),n.gameCount=e.response.game_count,n.games=r,a.resolve(n)}),a.promise).then(s.resolve,s.reject,s.notify),s.notify(e)},s.reject),s.promise}}]);